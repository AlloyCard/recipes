"use strict";var secret,decodedBinarySecret,AWS=require("aws-sdk"),region="us-east-1",axios=require("axios"),KMS=new AWS.KMS({region});const base64url=require("base64url"),fetch=require("node-fetch");var secretManager=new AWS.SecretsManager({region}),dynamoDb=new AWS.DynamoDB.DocumentClient,jwt=require("jsonwebtoken");const oAuthTableName="GoogleExporterOAuthTable",AlloyJS=require("@alloycard/alloy-js");async function buildAlloyJWT(e,t){const r={alg:"RS256",typ:"JWT",kid:`AlloyPrincipal-${e}`},a={exp:Math.floor(Date.now()/1e3)+60,iat:Math.floor(Date.now()/1e3),iss:"AlloyCard","custom:principalId":e,"custom:principalType":"com.alloycard.core.entities.recipe.Recipe"};let o={header:base64url(JSON.stringify(r)),payload:base64url(JSON.stringify(a))},n=Buffer.from(o.header+"."+o.payload),i=await KMS.sign({Message:n,KeyId:t,SigningAlgorithm:"RSASSA_PKCS1_V1_5_SHA_256",MessageType:"RAW"}).promise();return o.signature=i.Signature.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,""),o.header+"."+o.payload+"."+o.signature}async function setAlloyConfig(e,t){const r=await buildAlloyJWT(t,e);AlloyJS.AuthService.setAuthToken(r);const a=await AlloyJS.RecipesService.getRecipeInstallToken(t);return AlloyJS.AuthService.setAuthToken(a),await AlloyJS.RecipesService.changeRecipeInstallConfig(t,{oauthCompleted:!0})}async function insert(e){var t={TableName:oAuthTableName,Item:e};return new Promise(((e,r)=>{dynamoDb.put(t,(function(t,a){t?r(t):e(a)}))}))}async function getSecret(e){return new Promise(((t,r)=>{secretManager.getSecretValue({SecretId:e},(function(e,a){e?r(e):t(a.SecretString)}))}))}AlloyJS.configure({serverUrl:"http://127.0.0.1:8080/graphql",fetch}),exports.requestAuth=async(e,t)=>{try{const t=JSON.parse(await getSecret("/google/oauth")).client_id,r=e.queryStringParameters.recipeInstallId;return{statusCode:301,headers:{Location:`https://accounts.google.com/o/oauth2/v2/auth?client_id=${t}&redirect_uri=https://${e.headers.host}/redirect-to-app&response_type=code&scope=https://www.googleapis.com/auth/spreadsheets&access_type=offline&state=${r}`}}}catch(e){return console.log(e),e}},exports.setAlloyConfig=setAlloyConfig,exports.redirectToApp=async(e,t)=>{process.env.alloyKey;const r=e.queryStringParameters.code,a=e.queryStringParameters.state,o=JSON.parse(await getSecret("/google/oauth")),n=o.client_id,i=o.client_secret,s=`https://${e.headers.host}/redirect-to-app`,c=new URLSearchParams;c.append("client_id",n),c.append("client_secret",i),c.append("code",r),c.append("grant_type","authorization_code"),c.append("redirect_uri",s);const l=await axios.post("https://oauth2.googleapis.com/token",c,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return await insert({id:a,...l.data}),await setAlloyConfig,{statusCode:301,headers:{Location:`exp://192.168.137.1:19000/--/RecipeConfiguration?recipeInstallId=${a}&refresh=true`}}},exports.alloyWebhook=async(e,t)=>{};